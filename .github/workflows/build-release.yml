name: Build and Release OCR-GPT

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'
      release_notes:
        description: 'Release notes'
        required: false
        default: |
          ğŸš€ OCR-GPT Release
          
          ## æ–°åŠŸèƒ½
          - æˆªå›¾OCRè¯†åˆ« (Alt+1)
          - GPTæ™ºèƒ½é—®ç­”
          - ä¾¿æºå¼é…ç½®ç®¡ç†
          
          ## ä½¿ç”¨æ–¹æ³•
          1. ä¸‹è½½ OCR-GPT.exe
          2. è¿è¡Œç¨‹åº
          3. ç‚¹å‡»"è®¾ç½®"é…ç½®APIå¯†é’¥
          4. æŒ‰ Alt+1 å¼€å§‹ä½¿ç”¨

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: éªŒè¯å›¾æ ‡æ–‡ä»¶
      run: |
        if (Test-Path "ai.png") {
          Write-Output "âœ“ ai.png å­˜åœ¨"
          $size = (Get-Item "ai.png").Length / 1MB
          Write-Output "  æ–‡ä»¶å¤§å°: $([math]::Round($size, 2)) MB"
        } else {
          Write-Error "âœ— ai.png ä¸å­˜åœ¨"
          exit 1
        }
        
        if (Test-Path "ai.ico") {
          Write-Output "âœ“ ai.ico å­˜åœ¨"
          $size = (Get-Item "ai.ico").Length / 1KB
          Write-Output "  æ–‡ä»¶å¤§å°: $([math]::Round($size, 2)) KB"
        } else {
          Write-Error "âœ— ai.ico ä¸å­˜åœ¨"
          exit 1
        }
      shell: pwsh
      
    - name: éªŒè¯æ ¸å¿ƒæ–‡ä»¶
      run: |
        $requiredFiles = @("text_search.py", "config_manager.py", "build.py", "version_info.txt")
        foreach ($file in $requiredFiles) {
          if (Test-Path $file) {
            Write-Output "âœ“ $file å­˜åœ¨"
          } else {
            Write-Error "âœ— $file ä¸å­˜åœ¨"
            exit 1
          }
        }
      shell: pwsh
      
    - name: æ„å»ºåº”ç”¨ç¨‹åº
      run: |
        Write-Output "å¼€å§‹æ„å»º OCR-GPT..."
        python build.py
        
        # éªŒè¯æ„å»ºç»“æœ
        if (Test-Path "dist\OCR-GPT.exe") {
          $size = (Get-Item "dist\OCR-GPT.exe").Length / 1MB
          Write-Output "âœ“ æ„å»ºæˆåŠŸ! OCR-GPT.exe ($([math]::Round($size, 2)) MB)"
        } else {
          Write-Error "âœ— æ„å»ºå¤±è´¥ï¼Œæœªæ‰¾åˆ° OCR-GPT.exe"
          exit 1
        }
      shell: pwsh
      
    - name: åˆ›å»ºå‘å¸ƒåŒ…
      run: |
        # åˆ›å»ºå‘å¸ƒç›®å½•
        New-Item -ItemType Directory -Force -Path "release"
        
        # å¤åˆ¶ä¸»ç¨‹åº
        Copy-Item "dist\OCR-GPT.exe" "release\"
        
        # åˆ›å»ºä½¿ç”¨è¯´æ˜æ–‡ä»¶
        Write-Output "åˆ›å»ºä½¿ç”¨è¯´æ˜æ–‡ä»¶..."
        
        # ä½¿ç”¨ç®€å•çš„ PowerShell å­—ç¬¦ä¸²æ„å»º
        $title = "# OCR-GPT v${{ github.event.inputs.version }}"
        $quickStart = @(
          "",
          "## ğŸš€ å¿«é€Ÿå¼€å§‹",
          "",
          "1. **ä¸‹è½½å¹¶è¿è¡Œ**",
          "   - åŒå‡» OCR-GPT.exe å¯åŠ¨ç¨‹åº",
          "   - é¦–æ¬¡è¿è¡Œä¼šåœ¨ç¨‹åºç›®å½•åˆ›å»º config.json é…ç½®æ–‡ä»¶",
          "",
          "2. **é…ç½®APIå¯†é’¥**",
          "   - ç‚¹å‡»è®¾ç½®æŒ‰é’®",
          "   - é…ç½®ç™¾åº¦OCR APIï¼ˆå¯é€‰ï¼‰",
          "   - é…ç½®GPT APIï¼ˆå¿…éœ€ï¼‰",
          "",
          "3. **å¼€å§‹ä½¿ç”¨**",
          "   - æŒ‰ Alt+1 æˆªå›¾è¯†åˆ«æ–‡æœ¬",
          "   - åœ¨æ–‡æœ¬æ¡†ä¸­ç¼–è¾‘æˆ–è¾“å…¥é—®é¢˜",
          "   - æŒ‰å›è½¦æˆ–ç‚¹å‡»æé—®è·å–AIå›ç­”"
        )
        
        $apiConfig = @(
          "",
          "## ğŸ”§ APIé…ç½®",
          "",
          "### ç™¾åº¦OCRï¼ˆå¯é€‰ï¼‰",
          "- è®¿é—®ï¼šhttps://ai.baidu.com",
          "- è·å– API Key å’Œ Secret Key",
          "",
          "### GPT APIï¼ˆå¿…éœ€ï¼‰",
          "- æ¨èï¼šhttps://free.v36.cm",
          "- è·å– API Key"
        )
        
        $tips = @(
          "",
          "## ğŸ’¡ ä½¿ç”¨æŠ€å·§",
          "",
          "- å¿«æ·é”®: Alt+1 å¿«é€Ÿæˆªå›¾è¯†åˆ«",
          "- ç½®é¡¶çª—å£: å‹¾é€‰ç½®é¡¶ä¿æŒçª—å£åœ¨æœ€å‰",
          "- å›è½¦æé—®: åœ¨æ–‡æœ¬æ¡†ä¸­æŒ‰å›è½¦å¿«é€Ÿæé—®",
          "- ä¾¿æºä½¿ç”¨: ç¨‹åºå’Œé…ç½®æ–‡ä»¶å¯ä»¥ä¸€èµ·ç§»åŠ¨"
        )
        
        $notes = @(
          "",
          "## âš ï¸ æ³¨æ„äº‹é¡¹",
          "",
          "- éœ€è¦ç½‘ç»œè¿æ¥ä½¿ç”¨APIæœåŠ¡",
          "- é¦–æ¬¡è¿è¡Œå¯èƒ½è¢«æ€æ¯’è½¯ä»¶è¯¯æŠ¥ï¼Œè¯·æ·»åŠ ä¿¡ä»»",
          "- é…ç½®æ–‡ä»¶ä¿å­˜åœ¨ç¨‹åºåŒç›®å½•ï¼Œä¾¿äºå¤‡ä»½",
          "",
          "## ğŸ› é—®é¢˜åé¦ˆ",
          "",
          "å¦‚é‡é—®é¢˜ï¼Œè¯·è®¿é—®ï¼šhttps://github.com/${{ github.repository }}/issues",
          "",
          "---",
          "æ„å»ºæ—¶é—´: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')",
          "æ„å»ºç‰ˆæœ¬: ${{ github.event.inputs.version }}"
        )
        
        # åˆå¹¶æ‰€æœ‰å†…å®¹
        $allContent = $title + $quickStart + $apiConfig + $tips + $notes
        $allContent | Out-File -FilePath "release\ä½¿ç”¨è¯´æ˜.txt" -Encoding UTF8
        
        # åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
        $versionInfo = @{
          version = "${{ github.event.inputs.version }}"
          build_date = "$(Get-Date -Format 'yyyy-MM-dd')"
          build_time = "$(Get-Date -Format 'HH:mm:ss')"
          commit_sha = "${{ github.sha }}"
          repository = "${{ github.repository }}"
        }
        
        $versionInfo | ConvertTo-Json -Depth 2 | Out-File -FilePath "release\version.json" -Encoding UTF8
        
        Write-Output "âœ“ å‘å¸ƒåŒ…åˆ›å»ºå®Œæˆ"
        Get-ChildItem "release" | ForEach-Object { 
          $size = if ($_.Length -gt 1MB) { "$([math]::Round($_.Length / 1MB, 2)) MB" } else { "$([math]::Round($_.Length / 1KB, 2)) KB" }
          Write-Output "  $($_.Name) ($size)"
        }
      shell: pwsh
      
    - name: åˆ›å»ºZIPå‘å¸ƒåŒ…
      run: |
        # åˆ›å»ºZIPåŒ…
        Compress-Archive -Path "release\*" -DestinationPath "OCR-GPT-${{ github.event.inputs.version }}-windows.zip" -Force
        
        $zipSize = (Get-Item "OCR-GPT-${{ github.event.inputs.version }}-windows.zip").Length / 1MB
        Write-Output "âœ“ ZIPåŒ…åˆ›å»ºå®Œæˆ: OCR-GPT-${{ github.event.inputs.version }}-windows.zip ($([math]::Round($zipSize, 2)) MB)"
      shell: pwsh
      
    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v3
      with:
        name: OCR-GPT-${{ github.event.inputs.version }}
        path: |
          release/
          OCR-GPT-${{ github.event.inputs.version }}-windows.zip
        retention-days: 30
        
    - name: åˆ›å»ºGitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.event.inputs.version }}
        name: "OCR-GPT ${{ github.event.inputs.version }}"
        body: ${{ github.event.inputs.release_notes }}
        draft: false
        prerelease: false
        files: |
          release/OCR-GPT.exe
          release/ä½¿ç”¨è¯´æ˜.txt
          release/version.json
          OCR-GPT-${{ github.event.inputs.version }}-windows.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: æ„å»ºå®Œæˆé€šçŸ¥
      run: |
        Write-Output ""
        Write-Output "ğŸ‰ OCR-GPT ${{ github.event.inputs.version }} æ„å»ºå‘å¸ƒå®Œæˆ!"
        Write-Output ""
        Write-Output "ğŸ“¦ å‘å¸ƒå†…å®¹:"
        Write-Output "  - OCR-GPT.exe (ä¸»ç¨‹åº)"
        Write-Output "  - ä½¿ç”¨è¯´æ˜.txt (ç”¨æˆ·æŒ‡å—)"
        Write-Output "  - version.json (ç‰ˆæœ¬ä¿¡æ¯)"
        Write-Output "  - OCR-GPT-${{ github.event.inputs.version }}-windows.zip (å®Œæ•´åŒ…)"
        Write-Output ""
        Write-Output "ğŸ”— å‘å¸ƒåœ°å€: https://github.com/${{ github.repository }}/releases/tag/${{ github.event.inputs.version }}"
        Write-Output ""
      shell: pwsh